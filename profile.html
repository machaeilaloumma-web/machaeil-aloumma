<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - Ù…Ø´Ø§Ø¹Ù„ Ø§Ù„Ø£Ù…Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Kufi Arabic', sans-serif;
    }
    body {
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .profile-container {
      background: #1a1a25;
      padding: 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }
    h1 {
      color: #fff;
      margin-bottom: 16px;
      font-size: 24px;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 255, 128, 0.25);
    }
    .login-link {
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
    }
    .login-link a {
      color: #00ff80;
      text-decoration: none;
      transition: opacity 0.3s;
    }
    .login-link a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    #qrResult {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #2a2a35;
      display: none;
    }
    #qrImage {
      width: 240px;
      height: 240px;
      display: block;
      margin: 0 auto 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .action-btn {
      width: 100%;
      padding: 10px;
      background: #252535;
      color: #00ff80;
      border: 1px solid #2e2e3d;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 8px;
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      border-color: #00ff80;
      box-shadow: 0 0 12px rgba(0,255,128,0.3);
      transform: translateY(-2px);
    }
    .logout-btn {
      background: #2a2a35;
      color: #ff5555;
      border-color: #ff5555;
    }
    .logout-btn:hover {
      box-shadow: 0 0 12px rgba(255,85,85,0.4);
      transform: translateY(-2px);
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #2a2a35;
    }
    .info-label {
      color: #aaa;
      font-weight: 500;
      font-size: 15px;
    }
    .info-value {
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      text-align: left;
    }
    .button-group {
      margin-top: 16px;
    }
    .button-group button {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <h1>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    <button id="logoutBtn" class="action-btn logout-btn" style="display:none;">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

    <div id="noAccountMessage" class="login-link" style="display:none;">
      Ù„Ù… ØªÙÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¨Ø¹Ø¯. <a href="register.html">Ø§Ù†Ø¶Ù… ÙƒÙ€ "Ù†Ø¬Ù…"</a>
    </div>

    <div id="qrResult">
      <h3 style="color:#00ff80; margin-bottom:12px; text-align:center;">âœ… Ø­Ø³Ø§Ø¨Ùƒ Ø¬Ø§Ù‡Ø²!</h3>
      <p style="color:#ccc; margin-bottom:16px; text-align:center;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø£Ø³ØªØ§Ø°Ùƒ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ:</p>
      <img id="qrImage" src="" alt="Ø±Ù…Ø² QR Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨" />
      <div class="info-item"><span class="info-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</span><span class="info-value" id="fullNameDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span><span class="info-value" id="emailDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span><span class="info-value" id="levelDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©:</span><span class="info-value" id="institutionDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</span><span class="info-value" id="provinceDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</span><span class="info-value" id="cityDisplay"></span></div>
      <div class="info-item"><span class="info-label">Ø§Ù„Ø¬Ù†Ø³:</span><span class="info-value" id="genderDisplay"></span></div>
      <div class="button-group">
        <button id="copyBtn" class="action-btn" onclick="copyQRLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <button id="printBtn" class="action-btn" onclick="printQRCard()">Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ø¬Ù…</button>
        <button id="shareBtn" class="action-btn" onclick="shareQR()">Ù…Ø´Ø§Ø±ÙƒØ©</button>
        <button id="editBtn" class="action-btn" onclick="window.location.href='edit-profile.html'">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button id="homeBtn" class="action-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiypCTp31wIc5MR3FhClKobeQTeK-vaFs",
      authDomain: "machaeil-aloumma.firebaseapp.com",
      projectId: "machaeil-aloumma",
      storageBucket: "machaeil-aloumma.firebasestorage.app",
      messagingSenderId: "678363443395",
      appId: "1:678363443395:web:b604b002d4e8fd430d3276"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      const logoutBtn = document.getElementById('logoutBtn');
      const noAccountMessage = document.getElementById('noAccountMessage');
      const qrResult = document.getElementById('qrResult');

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      logoutBtn.style.display = 'block';
      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
      };

      try {
        let userSnap = await getDoc(doc(db, "users", user.uid));
        if (!userSnap.exists()) {
          userSnap = await getDoc(doc(db, "users", user.email));
        }

        if (userSnap.exists()) {
          const data = userSnap.data();
          noAccountMessage.style.display = 'none';
          qrResult.style.display = 'block';

          document.getElementById('fullNameDisplay').textContent = data.fullName || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('emailDisplay').textContent = data.email || user.email;
          document.getElementById('levelDisplay').textContent = data.level || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('institutionDisplay').textContent = data.institution || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('provinceDisplay').textContent = data.province || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('cityDisplay').textContent = data.city || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('genderDisplay').textContent = data.gender || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

          const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdfBDs6Ta8vt3AAM7aKGCaUymXWRNhW-9GFTmbhjnBTuuLvCg/viewform";
          const params = new URLSearchParams({
            'entry.500102530': data.fullName || '',
            'entry.1295909734': '',
            'entry.1782792963': data.level || '5',
            'entry.7598977': data.institution || '',
            'entry.1504285967': data.city || '',
            'entry.141302358': data.province?.split('-')[1]?.trim() || data.province || '',
            'entry.1987444241': data.gender || ''
          });
          const fullUrl = `${baseUrl}?${params.toString()}`;
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(fullUrl)}&qzone=1&margin=0`;

          document.getElementById('qrImage').src = qrUrl;
          document.getElementById('copyBtn').setAttribute('data-url', fullUrl);
          if (!navigator.share) document.getElementById('shareBtn').style.display = 'none';
        } else {
          noAccountMessage.style.display = 'block';
          qrResult.style.display = 'none';
        }
      } catch (err) {
        console.error("Firestore error:", err);
        noAccountMessage.style.display = 'block';
        qrResult.style.display = 'none';
      }
    });

    window.copyQRLink = function () {
      const url = document.getElementById('copyBtn').getAttribute('data-url');
      if (url) navigator.clipboard.writeText(url).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…!'));
    }

    window.printQRCard = function () {
      const fullName = document.getElementById('fullNameDisplay').textContent || 'Ø·Ø§Ù„Ø¨';
      const qrSrc = document.getElementById('qrImage').src;
      if (!qrSrc) return;
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>Ø¨Ø·Ø§Ù‚Ø© Ù†Ø¬Ù… - Ù…Ø´Ø§Ø¹Ù„ Ø§Ù„Ø£Ù…Ø©</title></head>
        <body style="font-family:'Noto Kufi Arabic',sans-serif;text-align:center;background:#000;color:#fff;padding:20px;">
          <h2 style="color:#ffcc00;">ğŸŒŸ Ù…Ø´Ø§Ø¹Ù„ Ø§Ù„Ø£Ù…Ø© â€“ Ø³ÙØ±Ø§Ø¡ Ø§Ù„Ù‚ÙŠÙ…</h2>
          <h3>Ø§Ù„Ø·Ø§Ù„Ø¨: ${fullName}</h3>
          <img src="${qrSrc}" style="width:240px;height:240px;margin:20px 0;" />
          <p style="color:#aaa;">Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨</p>
        </body></html>`);
      w.document.close();
      w.print();
    }

    window.shareQR = function () {
      const url = document.getElementById('copyBtn').getAttribute('data-url');
      if (navigator.share && url) {
        navigator.share({
          title: 'ØªÙ‚ÙŠÙŠÙ… Ù†Ø¬Ù… - Ù…Ø´Ø§Ø¹Ù„ Ø§Ù„Ø£Ù…Ø©',
          text: 'Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ "Ù…Ø´Ø§Ø¹Ù„ Ø§Ù„Ø£Ù…Ø©"',
          url
        });
      }
    }
  </script>
</body>
</html>



